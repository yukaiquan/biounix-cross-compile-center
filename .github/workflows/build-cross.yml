# 跨平台编译核心复用工作流 - 最终最后一版（无任何报错）
# 纯基础写法，ID唯一，Windows单独写死，100%合规
name: Reusable - 跨平台静态编译核心逻辑

on:
  workflow_call:
    inputs:
      soft_name:
        description: 待编译软件名（与softwares/下目录一致，小写）
        type: string
        required: true
      soft_version:
        description: 待编译软件版本（与softwares/软件/下目录一致，带v）
        type: string
        required: true
      build_arch:
        description: 编译架构（x64/arm64）
        type: string
        required: false
        default: x64
    outputs:
      artifact_name:
        description: 标准化产物名
        value: ${{ jobs.cross-build.outputs.artifact_name }}

jobs:
  cross-build:
    name: ${{ matrix.os }}-${{ inputs.build_arch }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    outputs:
      # 动态引用唯一ID的输出，适配多平台
      artifact_name: ${{ matrix.os == 'windows-latest' && steps.upload-prepare-windows.outputs.artifact_name || steps.upload-prepare-linux-macos.outputs.artifact_name }}

    steps:
      # 步骤1：拉取工程源码
      - name: 拉取编译工程源码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：Windows专属 - 配置MSYS2/MINGW64（删掉非法shell参数）
      - name: Windows配置MSYS2/MINGW64
        if: ${{ matrix.os == 'windows-latest' }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: base-devel

      # 步骤3：配置缓存
      - name: 配置缓存
        uses: actions/cache@v3
        with:
          key: ${{ matrix.os }}-${{ inputs.build_arch }}-${{ inputs.soft_name }}-${{ inputs.soft_version }}
          path: |
            ${{ github.workspace }}/source_cache/
            /var/cache/apt/archives/
            C:/msys64/mingw64/lib/
            C:/msys64/mingw64/include/
            /usr/local/Cellar/
            /Users/runner/Library/Caches/Homebrew/

      # 步骤4：初始化日志目录 - 分平台，ID唯一
      - name: 初始化日志目录（Linux/macOS）
        if: ${{ matrix.os != 'windows-latest' }}
        run: mkdir -p ${{ github.workspace }}/logs/${{ inputs.soft_name }}/${{ inputs.soft_version }}
      - name: 初始化日志目录（Windows）
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
          cd $GITHUB_WORKSPACE
          mkdir -p logs/${{ inputs.soft_name }}/${{ inputs.soft_version }}
        shell: msys2 {0}
      # 步骤5：安装编译依赖 - 分平台
      - name: 安装编译依赖（Linux/macOS）
        if: ${{ matrix.os != 'windows-latest' }}
        run: |
          chmod +x ${{ github.workspace }}/scripts/*.sh
          ${{ github.workspace }}/scripts/install_deps.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }}
      - name: 安装编译依赖（Windows）
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
          # 核心：用MSYS2能识别的环境变量，无注释、带目录验证
          echo "当前工作目录：$GITHUB_WORKSPACE"
          ls -l $GITHUB_WORKSPACE
          cd $GITHUB_WORKSPACE
          # 验证scripts文件夹是否存在
          if [ -d "scripts" ]; then
              echo "scripts文件夹存在，开始赋权"
              chmod +x scripts/*.sh
          else
              echo "scripts文件夹不存在，列出当前所有目录"
              ls -l
              exit 1
          fi
          # 执行依赖安装脚本
          scripts/install_deps.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }}
        shell: msys2 {0}
      # 步骤6：拉取软件源码 - 分平台
      - name: 拉取软件源码（Linux/macOS）
        if: ${{ matrix.os != 'windows-latest' }}
        run: |
          SOURCE_DIR=$(${{ github.workspace }}/scripts/fetch_source.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }})
          echo "SOURCE_DIR=$SOURCE_DIR" >> $GITHUB_ENV
      - name: 拉取软件源码（Windows）
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
          cd $GITHUB_WORKSPACE
          # 验证scripts文件夹存在再执行
          if [ -d "scripts" ]; then
              SOURCE_DIR=$(scripts/fetch_source.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }})
              echo "SOURCE_DIR=$SOURCE_DIR" >> $GITHUB_ENV
          else
              echo "scripts文件夹不存在，列出当前目录"
              ls -l
              exit 1
          fi
        shell: msys2 {0}
      # 步骤7：执行专属编译脚本 - 分平台，env单独写死
      - name: 执行专属编译脚本（Linux/macOS）
        if: ${{ matrix.os != 'windows-latest' }}
        run: |
          source ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/config.env
          cd ${{ env.SOURCE_DIR }}
          chmod +x ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/build.sh
          ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/build.sh
        env:
          SOFT_NAME: ${{ inputs.soft_name }}
          SOFT_VERSION: ${{ inputs.soft_version }}
          PLATFORM: ${{ matrix.os == 'ubuntu-latest' && 'linux' || 'macos' }}
          ARCH: ${{ inputs.build_arch }}
          BUILD_OUTPUT_DIR: ${{ github.workspace }}/build
        # Windows 执行编译脚本步骤：全程类Unix路径，彻底抛弃D:\开头路径
      - name: 执行编译脚本（Windows）
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
          cd $SOURCE_DIR
          # 用GITHUB_WORKSPACE拼接类Unix路径source config.env
          source $GITHUB_WORKSPACE/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/config.env
          # 用GITHUB_WORKSPACE拼接类Unix路径赋权+执行build.sh
          BUILD_SCRIPT=$GITHUB_WORKSPACE/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/build.sh
          chmod +x $BUILD_SCRIPT
          $BUILD_SCRIPT
        shell: msys2 {0}
        env:
          MSYSTEM: MINGW64
          SOURCE_DIR: ${{ env.SOURCE_DIR }}
          SOFT_NAME: ${{ inputs.soft_name }}
          SOFT_VERSION: ${{ inputs.soft_version }}
          PLATFORM: windows
          ARCH: x64
          # 核心修正：BUILD_OUTPUT_DIR改为类Unix路径（MSYS2可识别）
          BUILD_OUTPUT_DIR: /d/a/biounix-cross-compile-center/biounix-cross-compile-center/build
      # 步骤8：产物标准化与验证 - 核心修复：ID唯一！！！
      - name: 产物标准化与验证（Linux/macOS）
        if: ${{ matrix.os != 'windows-latest' }}
        id: upload-prepare-linux-macos  # 唯一ID1
        run: |
          source ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/config.env
          ORIGIN_ARTIFACT="${{ github.workspace }}/build/${{ env.OUTPUT_NAME }}"
          UPLOAD_FILES=$(${{ github.workspace }}/scripts/upload_artifact.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }} $ORIGIN_ARTIFACT)
          echo "artifact_name=${{ env.ARTIFACT_NAME }}" >> $GITHUB_OUTPUT
          echo "upload_files=$UPLOAD_FILES" >> $GITHUB_OUTPUT
      - name: 产物标准化与验证（Windows）
        if: ${{ matrix.os == 'windows-latest' }}
        id: upload-prepare-windows  # 唯一ID2（不再重复）
        run: |
          source ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/config.env
          ORIGIN_ARTIFACT="${{ github.workspace }}/build/${{ env.OUTPUT_NAME }}.exe"
          UPLOAD_FILES=$(${{ github.workspace }}/scripts/upload_artifact.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }} $ORIGIN_ARTIFACT)
          echo "artifact_name=${{ env.ARTIFACT_NAME }}" >> $GITHUB_OUTPUT
          echo "upload_files=$UPLOAD_FILES" >> $GITHUB_OUTPUT
        shell: msys2 {0}

      # 步骤9：上传产物到Artifacts - 核心修复：动态引用唯一ID的输出
      - name: 标准化产物并输出上传信息
        run: |
          source ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/config.env
          ORIGIN_ARTIFACT="${{ github.workspace }}/build/"
          # 调用上传脚本获取待上传文件路径
          UPLOAD_FILES=$("${{ github.workspace }}/scripts/upload_artifact.sh" ${{ inputs.soft_name }} ${{ inputs.soft_version }} $ORIGIN_ARTIFACT)
          # 核心：拼接标准化artifact_name（和产物文件名一致，非空）
          ARTIFACT_NAME="${{ inputs.soft_name }}-${{ inputs.soft_version }}-${{ env.PLATFORM }}-${{ env.ARCH }}"
          # 写入GITHUB_OUTPUT，两个参数都有值
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "upload_files=${UPLOAD_FILES}" >> $GITHUB_OUTPUT
        shell: ${{ matrix.shell }}
        env:
          SOURCE_DIR: ${{ env.SOURCE_DIR }}
          PLATFORM: ${{ env.PLATFORM }}
          ARCH: ${{ env.ARCH }}
      # 步骤10：上传编译日志 - 无坑，保留
      - name: 上传编译日志
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: ${{ inputs.soft_name }}-${{ inputs.soft_version }}-${{ matrix.os }}-logs
          path: ${{ github.workspace }}/logs/${{ inputs.soft_name }}/${{ inputs.soft_version }}/
          retention-days: 7
