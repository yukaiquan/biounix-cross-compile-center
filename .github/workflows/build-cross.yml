name: BioUnix Cross Build

on:
  # 支持手动从 Actions 页面运行
  workflow_dispatch:
    inputs:
      software:
        description: 'Software name (folder name in softwares/)'
        required: true
        default: 'poplddecay'
      version:
        description: 'Software version (folder name in softwares/NAME/)'
        required: true
        default: 'v3.43'
  
  # 【关键】支持被 dispatch.yml 调用
  workflow_call:
    inputs:
      software:
        required: true
        type: string
      version:
        required: true
        type: string

jobs:
  build:
    name: ${{ matrix.os-name }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os-name: linux
            arch: x64
            runner: ubuntu-latest
          # Linux ARM64
          - os-name: linux
            arch: arm64
            runner: ubuntu-24.04-arm64
          # macOS Apple Silicon (M1/M2/M3)
          - os-name: macos
            arch: arm64
            runner: macos-latest
          # macOS Intel
          - os-name: macos
            arch: x64
            runner: macos-13
          # Windows x64
          - os-name: windows
            arch: x64
            runner: windows-latest

    # 强制所有步骤在所有平台上使用 bash (包括 Windows)
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Windows 专用环境初始化
      - name: Setup MSYS2 (Windows Only)
        if: matrix.os-name == 'windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-zlib

      # 环境准备：统一输入变量名
      - name: Set Environment
        run: |
          echo "S_NAME=${{ inputs.software }}" >> $GITHUB_ENV
          echo "S_VER=${{ inputs.version }}" >> $GITHUB_ENV
          if [ "${{ matrix.os-name }}" == "windows" ]; then
            echo "EXE_EXT=.exe" >> $GITHUB_ENV
          else
            echo "EXE_EXT=" >> $GITHUB_ENV
          fi

      # 执行项目 scripts/ 目录下的通用脚本
      - name: Install Dependencies
        run: bash scripts/install_deps.sh ${{ env.S_NAME }} ${{ env.S_VER }}

      - name: Fetch Source
        run: |
          bash scripts/fetch_source.sh ${{ env.S_NAME }} ${{ env.S_VER }}
          # 假设 fetch_source.sh 会导出 SRC_PATH 到 $GITHUB_ENV 或文件
          if [ -f "build_env.txt" ]; then source build_env.txt; fi

      - name: Build
        run: |
          source config/global.env
          bash softwares/${{ env.S_NAME }}/${{ env.S_VER }}/build.sh

      # 收集产物
      - name: Prepare Artifacts
        run: |
          mkdir -p output_bin
          if [ -d "dist/bin" ]; then
            cp -r dist/bin/* output_bin/
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.S_NAME }}-${{ env.S_VER }}-${{ matrix.os-name }}-${{ matrix.arch }}
          path: output_bin/
          retention-days: 7
