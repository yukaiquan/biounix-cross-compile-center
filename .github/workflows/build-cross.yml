name: BioUnix Cross Build

on:
  workflow_dispatch:
    inputs:
      software:
        description: '软件名称'
        required: true
        default: 'poplddecay'
      version:
        description: '软件版本'
        required: true
        default: 'v3.43'
      platform:
        description: '目标平台'
        required: true
        default: 'all'
        type: choice
        options: [all, linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64]

  workflow_call:
    inputs:
      software:
        required: true
        type: string
      version:
        required: true
        type: string
      platform:
        required: true
        type: string

jobs:
  # --- 任务 1: 动态计算矩阵 ---
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # 定义所有可能的平台组合 (JSON 格式)
          ALL_PLATFORMS='{
            "include": [
              {"id": "linux-x64", "os-type": "linux", "arch": "x64", "runner": "ubuntu-latest"},
              {"id": "linux-arm64", "os-type": "linux", "arch": "arm64", "runner": "ubuntu-24.04-arm64"},
              {"id": "macos-arm64", "os-type": "macos", "arch": "arm64", "runner": "macos-latest"},
              {"id": "macos-x64", "os-type": "macos", "arch": "x64", "runner": "macos-15-intel"},
              {"id": "windows-x64", "os-type": "windows", "arch": "x64", "runner": "windows-latest","mshell": "msys2 {0}"}
            ]
          }'

          # 2. 根据输入逻辑进行处理，并务必使用 jq -c 压缩成单行
          if [[ "${{ inputs.platform }}" == "all" ]]; then
            # 选 all 时，压缩整个 JSON 
            RESULT=$(echo "$ALL_PLATFORMS" | jq -c .)
          else
            # 选特定平台时，过滤并压缩
            # 使用 --arg 安全传递变量
            RESULT=$(echo "$ALL_PLATFORMS" | jq -c --arg ID "${{ inputs.platform }}" '.include |= map(select(.id == $ID))')
          fi
          # 3. 输出到环境变量
          echo "matrix=$RESULT" >> $GITHUB_OUTPUT          

  # --- 任务 2: 执行编译 ---
  build:
    needs: setup
    name: ${{ matrix.id }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }} # 使用 setup 任务输出的矩阵

    defaults:
      run:
        shell: ${{ matrix.mshell || 'bash' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSYS2 (Windows Only)
        if: matrix.os-type == 'windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: base-devel mingw-w64-x86_64-gcc mingw-w64-x86_64-zlib

      - name: Prepare Environment
        run: |
          echo "S_NAME=${{ inputs.software }}" >> $GITHUB_ENV
          echo "S_VER=${{ inputs.version }}" >> $GITHUB_ENV
          [ "${{ matrix.os-type }}" == "windows" ] && echo "EXE_EXT=.exe" >> $GITHUB_ENV || echo "EXE_EXT=" >> $GITHUB_ENV

      - name: Install Dependencies
        run: bash scripts/install_deps.sh ${{ env.S_NAME }} ${{ env.S_VER }}

      - name: Fetch Source
        run: |
          bash scripts/fetch_source.sh ${{ env.S_NAME }} ${{ env.S_VER }}
          [ -f "build_env.txt" ] && cat build_env.txt >> $GITHUB_ENV || true

      - name: Build
        run: |
          source config/global.env
          bash softwares/${{ env.S_NAME }}/${{ env.S_VER }}/build.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.S_NAME }}-${{ env.S_VER }}-${{ matrix.id }}
          path: dist/bin/
          retention-days: 7
