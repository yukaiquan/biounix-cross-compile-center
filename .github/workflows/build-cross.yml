# 跨平台编译核心复用工作流 - 终极合规版
# 被trigger/*.yml/dispatch.yml调用，入参：soft_name(必填)、soft_version(必填)、build_arch(可选x64)
name: Reusable - 跨平台静态编译核心逻辑

on:
  workflow_call:
    inputs:
      soft_name:
        description: 待编译软件名（与softwares/下目录一致，小写）
        type: string
        required: true
      soft_version:
        description: 待编译软件版本（与softwares/软件/下目录一致，带v）
        type: string
        required: true
      build_arch:
        description: 编译架构（x64/arm64）
        type: string
        required: false
        default: x64
    outputs:
      artifact_name:
        description: 标准化产物名
        value: ${{ jobs.cross-build.outputs.artifact_name }}

jobs:
  cross-build:
    name: ${{ matrix.os }}-${{ inputs.build_arch }}
    strategy:
      fail-fast: false
      # 极简matrix：只保留基础os，无任何自定义字段（根治解析bug）
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    outputs:
      artifact_name: ${{ steps.upload-prepare.outputs.artifact_name }}
    steps:
      # 步骤1：拉取源码
      - name: 拉取编译工程源码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：Windows专属 - 配置MSYS2/MINGW64（单独指定shell，无需matrix）
      - name: Windows配置MSYS2/MINGW64
        if: ${{ contains(matrix.os, 'windows') }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: base-devel
        shell: msys2 {0}  # Windows步骤强制指定shell，合规

      # 步骤3：配置缓存（按os/架构/软件/版本分键）
      - name: 配置缓存
        uses: actions/cache@v3
        with:
          key: ${{ matrix.os }}-${{ inputs.build_arch }}-${{ inputs.soft_name }}-${{ inputs.soft_version }}
          path: |
            ${{ github.workspace }}/source_cache/
            /var/cache/apt/archives/
            C:/msys64/mingw64/lib/
            C:/msys64/mingw64/include/
            /usr/local/Cellar/
            /Users/runner/Library/Caches/Homebrew/

      # 步骤4：初始化日志目录（Linux/macOS用bash，Windows用msys2）
      - name: 初始化日志目录
        run: mkdir -p ${{ github.workspace }}/logs/${{ inputs.soft_name }}/${{ inputs.soft_version }}
        shell: ${{ contains(matrix.os, 'windows') && 'msys2 {0}' || 'bash' }}

      # 步骤5：安装编译依赖（自动适配shell）
      - name: 安装编译依赖
        run: |
          chmod +x ${{ github.workspace }}/scripts/*.sh
          ${{ github.workspace }}/scripts/install_deps.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }}
        shell: ${{ contains(matrix.os, 'windows') && 'msys2 {0}' || 'bash' }}

      # 步骤6：拉取软件源码（输出SOURCE_DIR到环境变量）
      - name: 拉取软件源码
        run: |
          SOURCE_DIR=$(${{ github.workspace }}/scripts/fetch_source.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }})
          echo "SOURCE_DIR=$SOURCE_DIR" >> $GITHUB_ENV
        shell: ${{ contains(matrix.os, 'windows') && 'msys2 {0}' || 'bash' }}

      # 步骤7：执行专属编译脚本（核心，source加载config.env，自动适配shell）
      - name: 执行专属编译脚本
        run: |
          # 加载软件配置文件（替代原env块非法写法）
          source ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/config.env
          # 进入源码目录执行编译
          cd ${{ env.SOURCE_DIR }}
          chmod +x ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/build.sh
          ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/build.sh
        shell: ${{ contains(matrix.os, 'windows') && 'msys2 {0}' || 'bash' }}
        env:
          # 静态环境变量，100%合规
          SOFT_NAME: ${{ inputs.soft_name }}
          SOFT_VERSION: ${{ inputs.soft_version }}
          PLATFORM: ${{ contains(matrix.os, 'ubuntu') && 'linux' || contains(matrix.os, 'windows') && 'windows' || 'macos' }}
          ARCH: ${{ inputs.build_arch }}
          BUILD_OUTPUT_DIR: ${{ github.workspace }}/build

      # 步骤8：产物标准化+验证（修复所有语法，自动适配shell）
      - name: 产物标准化与验证
        id: upload-prepare
        run: |
          source ${{ github.workspace }}/softwares/${{ inputs.soft_name }}/${{ inputs.soft_version }}/config.env
          # 基础产物路径
          ORIGIN_ARTIFACT="${{ github.workspace }}/build/${{ env.OUTPUT_NAME }}"
          # Windows加.exe后缀
          if [ "${{ contains(matrix.os, 'windows') }}" = "true" ]; then
              ORIGIN_ARTIFACT="${ORIGIN_ARTIFACT}.exe"
          fi
          # 调用上传脚本
          UPLOAD_FILES=$(${{ github.workspace }}/scripts/upload_artifact.sh ${{ inputs.soft_name }} ${{ inputs.soft_version }} $ORIGIN_ARTIFACT)
          # 输出变量
          echo "artifact_name=${{ env.ARTIFACT_NAME }}" >> $GITHUB_OUTPUT
          echo "upload_files=$UPLOAD_FILES" >> $GITHUB_OUTPUT
        shell: ${{ contains(matrix.os, 'windows') && 'msys2 {0}' || 'bash' }}

      # 步骤9：上传产物到Artifacts
      - name: 上传产物到Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.upload-prepare.outputs.artifact_name }}
          path: ${{ steps.upload-prepare.outputs.upload_files }}
          retention-days: 30
          if-no-files-found: error

      # 步骤10：上传编译日志（无论成败都传）
      - name: 上传编译日志
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: ${{ inputs.soft_name }}-${{ inputs.soft_version }}-${{ contains(matrix.os, 'ubuntu') && 'linux' || contains(matrix.os, 'windows') && 'windows' || 'macos' }}-logs
          path: ${{ github.workspace }}/logs/${{ inputs.soft_name }}/${{ inputs.soft_version }}/
          retention-days: 7
